// Função para converter arquivo em Base64
async function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        if (!file) resolve(null);
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
}

async function calcularSimulacao() {
    const editId = document.getElementById('editId').value;
    
    // Captura de arquivos (Novos ou manter antigos se estiver editando)
    const fileNFCompra = document.getElementById('nfCompra').files[0];
    const fileNFVenda = document.getElementById('nfVenda').files[0];
    const fileDecl = document.getElementById('fileDeclaracao').files[0];

    // Se estiver editando, busca o item antigo para manter os arquivos caso não suba novos
    let itemAntigo = editId ? historico.find(i => i.id == editId) : null;

    const f = {
        empresa: document.getElementById('nomeEmpresa').value,
        regime: document.getElementById('regimeTributario').value,
        bem: document.getElementById('descricao').value,
        vlrAq: parseCurrency(document.getElementById('valorAquisicao').value),
        vlrVenda: parseCurrency(document.getElementById('valorVenda').value),
        despesas: parseCurrency(document.getElementById('despesasVenda').value),
        dtAq: document.getElementById('dataAquisicao').value,
        dtVenda: document.getElementById('dataVenda').value,
        taxa: parseFloat(document.getElementById('tipoDepreciacao').value),
        // Processamento de arquivos
        docCompra: fileNFCompra ? await fileToBase64(fileNFCompra) : (itemAntigo ? itemAntigo.docCompra : null),
        docVenda: fileNFVenda ? await fileToBase64(fileNFVenda) : (itemAntigo ? itemAntigo.docVenda : null),
        docDecl: fileDecl ? await fileToBase64(fileDecl) : (itemAntigo ? itemAntigo.docDecl : null),
        docImposto: itemAntigo ? itemAntigo.docImposto : null // Mantém o imposto já anexado
    };

    if(!f.empresa || !f.dtAq || !f.dtVenda) { alert("Preencha os campos."); return; }

    const tempo = calcularDiferencaTempo(f.dtAq, f.dtVenda);
    let depAc = ((f.vlrAq * (f.taxa/100)) / 12) * tempo.totalMeses;
    if(depAc > f.vlrAq) depAc = f.vlrAq;
    const vlrCont = f.vlrAq - depAc;
    const ganho = (f.vlrVenda - f.despesas) - vlrCont;

    let imposto = ganho > 0 ? (f.regime === 'simples' ? ganho * 0.15 : ganho * 0.34) : 0;
    
    const novoItem = { 
        ...f, 
        id: editId ? parseInt(editId) : Date.now(), 
        imposto, 
        tempoStr: `${tempo.anos}a ${tempo.meses}m`, 
        ganhoCapital: ganho > 0 ? ganho : 0,
        code: f.regime === 'simples' ? "0507" : "IRPJ/CSLL"
    };

    salvar(novoItem);
    alert(editId ? "Registro Atualizado!" : "Cálculo Salvo!");
    limparFormulario();
    switchTab('historico');
}
