<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Extrator PGDAS-D | Soma Automática</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        :root { --fundo: #0c0c0c; --card: #1a1a1a; --laranja: #ff8c00; --texto: #e0e0e0; --borda: #333; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--fundo); color: var(--texto); margin: 0; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--laranja); padding-bottom: 20px; margin-bottom: 30px; }
        h2 { color: var(--laranja); text-transform: uppercase; margin: 0; }
        .btn-import { background-color: var(--laranja); color: #000; padding: 12px 25px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .table-wrapper { background-color: var(--card); border-radius: 8px; border: 1px solid var(--borda); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; table-layout: fixed; }
        th { background-color: #111; color: var(--laranja); padding: 10px; text-align: left; border-bottom: 2px solid var(--laranja); }
        td { padding: 12px; border-bottom: 1px solid var(--borda); vertical-align: middle; }
        
        .row-main { background-color: rgba(255, 140, 0, 0.15); font-weight: bold; }
        .desc-full { color: #fff; font-size: 10px; line-height: 1.4; text-align: left; padding-left: 12px; font-weight: bold; border-left: 3px solid var(--laranja); }
        .total-cell { font-weight: bold; color: var(--laranja); }
        #status { color: var(--laranja); margin-bottom: 10px; font-weight: bold; }

        .col-info { width: 110px; }
        .col-cnpj { width: 130px; }
        .col-raz { width: 180px; }
        .col-val { width: 95px; }
    </style>
</head>
<body>

    <div class="header">
        <h2>Extração PGDAS-D - Soma por Atividade</h2>
        <input type="file" id="fileInput" accept=".pdf" multiple style="display: none;">
        <button class="btn-import" onclick="document.getElementById('fileInput').click()">IMPORTAR ARQUIVOS</button>
    </div>

    <div id="status"></div>

    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th class="col-info">Mês/Ano</th>
                    <th class="col-cnpj">CNPJ Matriz</th>
                    <th class="col-raz">Razão Social</th>
                    <th>Descrição / Atividade</th>
                    <th class="col-val">RBT12 (R$)</th>
                    <th class="col-val">Receita Ativ. (R$)</th>
                    <th style="width:65px">IRPJ</th>
                    <th style="width:65px">CSLL</th>
                    <th style="width:65px">COFINS</th>
                    <th style="width:65px">PIS</th>
                    <th style="width:65px">INSS</th>
                    <th style="width:65px">ICMS</th>
                    <th style="width:65px">IPI</th>
                    <th style="width:65px">ISS</th>
                    <th style="width:85px" class="total-cell">TOTAL</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

<script>
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    // Funções auxiliares para conversão de valores
    const parseCurrency = (val) => parseFloat(val.replace(/\./g, '').replace(',', '.')) || 0;
    const formatCurrency = (val) => val.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    document.getElementById('fileInput').addEventListener('change', async (e) => {
        const files = e.target.files;
        if (!files.length) return;
        document.getElementById('status').innerText = "Processando...";
        for (let file of files) { await processFile(file); }
        document.getElementById('status').innerText = "Processamento concluído!";
    });

    async function processFile(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = async function() {
                const typedarray = new Uint8Array(this.result);
                const pdf = await pdfjsLib.getDocument(typedarray).promise;
                let fullText = "";
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    fullText += content.items.map(item => item.str).join(" ") + " \n ";
                }
                parseAndSum(fullText.replace(/\s+/g, ' '));
                resolve();
            };
            reader.readAsArrayBuffer(file);
        });
    }

    function parseAndSum(text) {
        const meses = ["JANEIRO", "FEVEREIRO", "MARÇO", "ABRIL", "MAIO", "JUNHO", "JULHO", "AGOSTO", "SETEMBRO", "OUTUBRO", "NOVEMBRO", "DEZEMBRO"];
        const matchData = text.match(/Período de Apuração:\s*01\/(\d{2})\/(\d{4})/);
        const mesExtenso = matchData ? `${meses[parseInt(matchData[1], 10) - 1]}/${matchData[2]}` : "N/A";

        const cnpjMatch = text.match(/(\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2})/);
        const cnpj = cnpjMatch ? cnpjMatch[1] : "N/A";
        const nomeMatch = text.match(/Nome empresarial:\s*(.*?)\s*Data de abertura/);
        const razao = nomeMatch ? nomeMatch[1].trim() : "N/A";
        
        const rbtMatch = text.match(/RBT12\)\s*[\d.,]+\s*[\d.,]+\s*([\d.]+,\d{2})/);
        const rbt12 = rbtMatch ? rbtMatch[1] : "0,00";

        // Array para acumular as somas dos impostos (9 posições: IRPJ a Total)
        let somas = [0,0,0,0,0,0,0,0,0];
        let linhasAtividade = [];

        // Extração das atividades
        const partes = text.split("Valor do Débito por Tributo para a Atividade (R$):");
        for (let i = 1; i < partes.length; i++) {
            let bloco = partes[i].split("Totais do Estabelecimento")[0];
            const descMatch = bloco.match(/^(.*?)\s*Receita Bruta Informada/);
            const recMatch = bloco.match(/Receita Bruta Informada\s*:\s*R\$\s*([\d.]+,\d{2})/);
            const impostosPart = bloco.split("Total")[1];
            const vals = impostosPart ? impostosPart.trim().match(/[\d.]+,\d{2}/g) : null;

            if (descMatch && recMatch && vals && vals.length >= 9) {
                const desc = descMatch[1].trim();
                const receita = recMatch[1].trim();
                const impostos = vals.slice(0, 9);
                
                // Soma os valores numericamente
                impostos.forEach((v, index) => { somas[index] += parseCurrency(v); });
                
                linhasAtividade.push({ desc, receita, impostos });
            }
        }

        // Renderiza a linha de resumo com a SOMA REAL CALCULADA
        const impostosSomados = somas.map(v => formatCurrency(v));
        renderMainRow(mesExtenso, cnpj, razao, rbt12, impostosSomados);

        // Renderiza as atividades logo abaixo
        linhasAtividade.forEach(linha => {
            renderActivityRow(linha.desc, linha.receita, linha.impostos);
        });
    }

    function renderMainRow(periodo, cnpj, razao, rbt, taxes) {
        const html = `<tr class="row-main">
            <td style="color:var(--laranja)">${periodo}</td>
            <td>${cnpj}</td>
            <td>${razao}</td>
            <td></td>
            <td>${rbt}</td>
            <td>-</td>
            ${taxes.map((t, i) => `<td class="${i===8?'total-cell':''}">${t}</td>`).join('')}
        </tr>`;
        document.getElementById('tableBody').insertAdjacentHTML('beforeend', html);
    }

    function renderActivityRow(desc, receita, taxes) {
        const html = `<tr class="row-activity">
            <td colspan="4" class="desc-full">${desc}</td>
            <td>-</td>
            <td style="font-weight:bold">${receita}</td>
            ${taxes.map((t, i) => `<td class="${i===8?'total-cell':''}">${t}</td>`).join('')}
        </tr>`;
        document.getElementById('tableBody').insertAdjacentHTML('beforeend', html);
    }
</script>
</body>
</html>